# Demo: Vault on Kubernetes

## Minikube

To enable Kubernetes CA in minikube installation, start it by running

    minikube start --extra-config=controller-manager.ClusterSigningCertFile="/var/lib/localkube/certs/ca.crt" --extra-config=controller-manager.ClusterSigningKeyFile="/var/lib/localkube/certs/ca.key"


## Preparations

Build container by following instructions in [docker/README.md](docker/README.md)

Generate server certificate for Vault

    # install cfssl tools to generate key and CSR
    go get -v -u github.com/cloudflare/cfssl/cmd/...

    # generate private key and certificate signing request for Vault
    cfssl genkey configs/cfssl-vault-server-csr.json | cfssljson -bare vault

    # send CSR to kubernetes CA
    CSR=$(cat vault.csr | base64 | tr -d '\n') envsubst < manifests/vault-csr.yaml | kubectl create -f -

    # approve the request
    kubectl certificate approve vault

    # check that status changed to `Approved,Issued`.
    kubectl describe csr vault

    # fetch the certificate
    kubectl get csr vault -o jsonpath='{.status.certificate}' | base64 -d > vault.pem

    # remove the CSR
    kubectl delete csr vault

    # check that the certificate looks ok
    cfssl certinfo -cert vault.pem


## Deploy Vault

Create configmap for `vault.hcl` configuration file

    kubectl create configmap vault-config --from-file=configs/vault.hcl
    kubectl get configmap vault-config -o json | jq .


Create secret for Vault HTTPS certificate and private key

    kubectl create secret generic vault-cert --from-file=vault.pem --from-file=vault-key.pem
    kubectl get secret vault-cert -o json | jq .


Create deployment

    kubectl apply -f manifests/vault.yaml



## Unseal vault

Launch new container and install [httpie](https://httpie.org)


    kubectl run --rm -it --image=alpine ash
    apk -U add httpie


Check that Vault server can be reached.  The REST API documentation can be found [here](https://www.vaultproject.io/api/index.html)

    http -v --verify=/run/secrets/kubernetes.io/serviceaccount/ca.crt  https://vault:8200/v1/sys/health


Initialize Vault in order to generate key shares

    http -v --verify=/run/secrets/kubernetes.io/serviceaccount/ca.crt PUT https://vault:8200/v1/sys/init secret_shares:=1 secret_threshold:=1


Unseal Vault with unseal key generated by previous step

    http -v --verify=/run/secrets/kubernetes.io/serviceaccount/ca.crt PUT https://vault:8200/v1/sys/unseal key=8c54dbe2c5489df89a2f61577223c93361f884038a87f47ae24d0b804ae8bf86


Call API end-points with authentication token (e.g. root token provided by init step)

    http -v --verify=/run/secrets/kubernetes.io/serviceaccount/ca.crt  https://vault:8200/v1/sys/mounts "X-Vault-Token: 60c8d58c-4621-3f2e-c649-9f2469300eeb"
